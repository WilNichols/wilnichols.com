{% from "footer.njk" import Footer with context %}
{% from "picture.njk" import Picture with context %}
{% from "tag.njk" import tag as tagButton %}

{% macro shot(post) -%}
  {{ post.content | safe }}
{%- endmacro %}

{% macro endProject(name) -%}
  </ol></div></li>
{%- endmacro %}

{% macro projectMeta(thisDesign, postInfo, learnMoreLink) -%}
{% set name %}{{ postInfo.project | slugify | replace('-', '') }}{% endset %}
{% set animationTimelineName %}--{{ name }}-shots{% endset %}
  <li class="project" style="timeline-scope: {{ animationTimelineName }}">
    <div class="project__meta">
      <h2 class="project__title"><span class="project__name">{{ postInfo.project }}</span></h2>
      <div class="project__meta__trailing">
        {% if thisDesign.length > 1 %}
          <ul class="project__meta__pager">
            {% for i in range(thisDesign.length) %}
              {% set i0 = loop.index0 %}
              {% set start = (i0 / thisDesign.length * 100) %}
              {% set end = ((i0 + 1) / thisDesign.length * 100) %}
              <li class="project__meta__pager__dot" style="
                animation-timeline: {{ animationTimelineName }};
                --start: {{ start }}%;
                 --end: {{ end }}%">
              </li>
            {% endfor %}
          </ul>
        {% endif %}
        {{ tagButton(postInfo.client) }}
      </div>
    </div>
    <div class="scroll-thief scroll-thief--shot"></div>
    <div class="shots-container">
      <ol class="shots" id="shots--{{ name | lower | replace('[^a-z0-9-]', '-', 'g') }}" style="scroll-timeline-name: {{ animationTimelineName }}">
{%- endmacro %}

{% macro shotList(collection) -%}
  <ol class="project-list" reversed>
    {% set drafts = collections.Drafts | draftsOf(collection) %}
    {% set info = {} %}
    {% asyncEach post in collection | reverse %}
      {% set postInfo = {
        project: post.data.tags | getNestedTag("Design"),
        client: post.data.tags | getNestedTag("Client")
      } %}
      {% set name %}{{ postInfo.project | slugify | replace('-', '') }}{% endset %}
      {% set filterClass = "" %}
      {% if post.data.inputFilter == "Coarse" %}
        {% set filterClass = "design--mobile" %}  
      {% elif post.data.inputFilter == "Pointer" %}  
        {% set filterClass = "design--desktop" %}  
      {% endif %}
      {% if info.project != postInfo.project %}
        {# closes the loop for most shots #}
        {% if (loop.index > 1 ) %}{{ endProject(name) }}{% endif %}
        {% set thisDesign = null %}
        {%- set thisDesign %}{%- for tag in post.data.tags -%}{{- tag if "Design/" in tag -}}
        {%- endfor -%}{%- endset -%}

        {{ projectMeta(collections[thisDesign], postInfo, false)}}
      {% endif %}
      <li class="shot {{ filterClass }}">
        {{ shot(post) }}
      </li>
      {% if loop.index == loop.length %}{{ endProject(name) }}{% endif %}
      {% set info = postInfo %}
    {% endeach %}
  </ol>

{% js "defer" %}  
    document.querySelectorAll('.shots[id^="shots--"]').forEach((scroller) => {
      scroller.addEventListener('scroll', () => {
        const max = scroller.scrollHeight - scroller.clientHeight;
        const progress = max > 0 ? (scroller.scrollTop / max) : 0;

        console.log(
          scroller.dataset.shotsName || scroller.id,
          'scroll progress:',
          progress.toFixed(3)
        );
      }, { passive: true });
    });
{% endjs %}
{%- endmacro %}
