@use 'sass:math';
@use 'color';

@mixin light-dark($prop, $lightColor, $darkColor: $lightColor) {
  #{$prop}: $lightColor;
  @media (prefers-color-scheme: dark) {
    #{$prop}: $darkColor;
  }
}

* {
  box-sizing: border-box;
}

// Typography. This isn't _the_ solution — I haven't tried much with fluid scales yet, but it's _a_ solution for now. 
/* @link https://utopia.fyi/type/calculator?c=320,17,1.2,1200,20,1.25,5,2,&s=0.75|0.5|0.25,1.5|2|3|4|6,s-l&g=s,l,xl,12 */

:root {
  // type
  --type--2: clamp(0.7378rem, 0.7152rem + 0.113vi, 0.8rem);
  --type--1: clamp(0.8854rem, 0.8438rem + 0.2083vi, 1rem);
  --type-0: clamp(1.0625rem, 0.9943rem + 0.3409vi, 1.25rem);
  --type-1: clamp(1.275rem, 1.1705rem + 0.5227vi, 1.5625rem);
  --type-2: clamp(1.53rem, 1.3761rem + 0.7693vi, 1.9531rem);
  --type-3: clamp(1.836rem, 1.6159rem + 1.1007vi, 2.4414rem);
  --type-4: clamp(2.2032rem, 1.8946rem + 1.5428vi, 3.0518rem);
  --type-5: clamp(2.6438rem, 2.2181rem + 2.1288vi, 3.8147rem);
  // colors
  @include light-dark(--materialPrimaryColor, var(--c100), var(--c0));
  @include light-dark(--materialPrimaryHoverColor, var(--cK95), var(--cK5));
  @include light-dark(--contentPrimaryColor, var(--cK5), var(--c100));
  @include light-dark(--contentSecondaryColor, var(--cK50), var(--cK60));
  @include light-dark(--contentTertiaryColor, var(--cK70), var(--cK40));
  @include light-dark(--linkColor, var(--cB30), var(--cB50));
  @include light-dark(--linkVisitedColor, var(--cP30), var(--cP50));
  @include light-dark(--tagBackgroundColor, var(--cK90), var(--cK20));
  @include light-dark(--tagBorderColor, var(--cK80), var(--cK30));
  @include light-dark(--tagContentColor, var(--cK30), var(--cK90));
  @include light-dark(--evergreenBackgroundColor, var(--cG90), var(--cG20));
  @include light-dark(--evergreenBorderColor, var(--cG80), var(--cG30));
  @include light-dark(--evergreenContentColor, var(--cG30), var(--cG90));
  @include light-dark(--evergreenVersionBackgroundColor, var(--cG40), var(--cG50));
  @include light-dark(--evergreenVersionBorderColor, var(--cG30), var(--cG60));
  @include light-dark(--evergreenVersionContentColor, var(--c100), var(--c0abs));
  @include light-dark(--edgeColor, var(--cK90a), var(--cK10d));
  // layout
  --px: calc(1px / var(--density, 1));
  @media (-webkit-min-device-pixel-ratio: 2) {
    --density: 2;
  }
  @media (-webkit-min-device-pixel-ratio: 3) {
    --density: 3;
  }
  --col: calc(100dvw/12);
}

$width: calc(30 * var(--type-0));
$breakpoint: 480px;

%font--display-regular {
  font-family: "neue-haas-grotesk-display", sans-serif;
  font-weight: 500;
  font-style: normal;
}

%font--display-medium {
  font-family: "neue-haas-grotesk-display", sans-serif;
  font-weight: 600;
  font-style: normal;
}

%font--display-black {
  font-family: "neue-haas-grotesk-display", sans-serif;
  font-weight: 900;
  font-style: normal;
}

%font--text-regular {
  font-family: "neue-haas-grotesk-text", sans-serif;
  font-weight: 400;
  font-style: normal;
}

%font--text-regular--italic {
  font-family: "neue-haas-grotesk-text", sans-serif;
  font-weight: 400;
  font-style: italic;
}

%font--text-italic {
  font-family: "neue-haas-grotesk-text", sans-serif;
  font-weight: 500;
  font-style: normal;
}

body {
  font-size: var(--type-0);
  @extend %font--text-regular;
  display: grid;
  place-content: center;
  padding: 0;
  margin: 0;
  min-height: 100dvh;
  background-color: var(--materialPrimaryColor);
  color: var(--contentPrimaryColor);
}

h1, h2, h3, h4, h5, h6, p, span {
  font-size: 1em;
  // line-height: 1.5em;
  font-weight: unset;  
  margin: 0;
  padding: 0;
}

ol, ul {
  margin: 0;
  padding: 0;
  list-style: none;
}

p:last-child {
  margin-bottom: 0;
}

p, h1, h2, h3, h4, h5, h6, .note-title {  
  max-width: $width;
  text-wrap: balance;
}

p {
  margin: 0 auto 1em auto;
}

a {
  color: var(--contentPrimaryColor);
  p & {
    color: var(--linkColor);
    &:visited {
      color: var(--linkVisitedColor);
    }
  }
}

.note__header {
  display: inline-flex;
  flex-direction: column;
  margin: 0 auto 1.25em 0;
}

@for $i from 1 through 6 {
  .heading--#{$i} {
    // margin: 0 0 .25em 0;
    font-size: var(--type-#{$i * 6 - $i});
    @extend %font--display-medium;
  }
}

.heading--1 {
  line-height: 1em;
  margin: 0 0 .25em 0;
}

.page__title {
  @extend .heading--1;
  @extend %font--display-black;
}

.page__subtitle {
  font-size: var(--type--1);
  @extend %font--text-regular;
  display: block;
  color: var(--contentSecondaryColor);

}

.note__body p {
  line-height: 1.5em;
}

.album__album-photos {
  display: flex;
  flex-direction: column;
  gap: calc(var(--col) / 2);
  padding: 0 calc(var(--col) / 2);
  box-sizing: content-box;
}

.album__album-photos__photo {
  display: flex;
  place-content: center;
  picture {
    display: block;
    aspect-ratio: var(--ratio);
    background-color: var(--color);
    height: 100%;
    max-height: calc(100dvh - 32px);
  }
  img {
    display: block;
    width: 100%;
    height: 100%;
    overflow: hidden;

  } 
}

.backlinks {
  max-width: $width;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: var(--type--2);
  .note__body + & {
    margin-top: 1em;
  }
}

.backlinks__title {
  font-size: var(--type--1);
  @extend %font--display-medium;
  color: var(--contentSecondaryColor);
}

.backlinks__list {
  padding: 0;
  margin: 0;
  display: flex;
  gap: var(--type-0);
  flex-wrap: wrap;
}

.backlink__container {
  @media screen and (min-width: 415px) {
    width: calc(50% - var(--type-0));
  }
}

.backlink {
  display: inline-flex;
  flex-direction: column;
  gap: var(--type--2);
  font-size: var(--type--2);
  border-radius: 12px;
  padding: 12px 16px;
  overflow: hidden;
  position: relative; 
  margin: 0;
  text-decoration: none;
  &::after {
    content: '';
    position: absolute;
    inset: 0;
    color: var(--contentPrimaryColor);
    opacity: var(--opacity, 0.05);
    z-index: -10;
  }
  &:hover {
    --opacity: 0.075;
  }
  &:active {
    --opacity: 0.1;
  }
}

.backlink__title {
  font-size: var(--type--1);
  @extend %font--display-medium;
}

.backlink__title, .backlink__preview {
  color: var(--contentPrimaryColor);
}

.backlink__preview {
  @media screen and (min-width: 415px) {
    -webkit-line-clamp: 3;
    text-overflow: ellipsis;
    overflow: hidden;
    display: -webkit-box;
    -webkit-box-orient: vertical; 
  }
}

.note-list {
  display: grid;
  grid-template-columns: min-content auto min-content;
  row-gap: 1.2em;
  // TODO: extract this
  max-width: 400px;
  @media (width <= $breakpoint) {
    max-width: unset;
    width: 100%;
  }
}

.note-group__month {
  display: flex;
  flex-direction: row-reverse;
}

.note__month {
  width: 100%;
}

.note__month, .note__year {
  @extend .heading--6;
  @extend %font--display-medium;
}

.note__year, .note__month, .note__day {
  color: var(--contentSecondaryColor);
}

.note__accessories {
  display: flex;
  flex-direction: row-reverse;
  gap: 5px;
  min-height: 1.25em;
  line-height: 1.25em;
  align-items: center;
  > li {
    display: contents;
  }
}

.note__type {
  $r: 4px;
  $p: 3px 5px;
  position: relative;
  display: inline-flex;
  justify-self: flex-end;
  // height: 16px;
  line-height: 100%;
  border-radius: $r;
  background-color: var(--tagBackgroundColor);
  color: var(--tagContentColor);
  box-shadow: inset 0 0 0 var(--px) var(--tagBorderColor);
  font-size: 8pt;
  padding: $p;
  letter-spacing: 1px;
  text-transform: uppercase;
  @extend %font--display-medium; 
  @include light-dark(mix-blend-mode, multiply, screen);
  gap: 5px;
  overflow: clip;
  user-select: none;
  -webkit-user-select: none;
  &--evergreen {
    background-color: var(--evergreenBackgroundColor);
    color: var(--evergreenContentcolor);
    box-shadow: inset 0 0 0 var(--px) var(--evergreenBorderColor);
    &::after {
      content: attr(data-version);
      padding: $p;
      margin: -3px -5px -3px -2px;
      background-color: var(--evergreenVersionBackgroundColor);
      color: var(--evergreenVersionContentColor);
      box-shadow: inset 0 0 0 var(--px) var(--evergreenVersionBorderColor);
      border-radius: 0 $r $r 0;
    }
  }
}

$t: .2s;

%listItemBackground::before {
  content: '';
  z-index: 0;
  position: absolute;
  inset: -6px -8px;
  border-radius: .6em;
  background-color: var(--materialPrimaryHoverColor);
  opacity: 0;
  will-change: opacity;
  filter: blur(.3em);
  $t: $t * 4;
  transition: $t opacity ease-out, $t filter ease-out;
}

%listItemBackgroundHover::before {
  opacity: 1;
  filter: blur(0);
  transition-duration: math.div($t, 4);
}

%listItemBackgroundActive {
  scale: .99;
}
  
.note {
  // necessary for subgrid
  display: contents;
}

.note__link, .note-group__month {
  grid-column: 1 / -1;
}

$note-title-gap: .25em; // the size of a monospaced space character in Neue Haas Grotesk
.note__link {
  display: grid;
  grid-template-columns: subgrid;
  text-decoration: none;
  gap: $note-title-gap;
  align-items: flex-start;
  color: var(--contentPrimaryColor);
  position: relative;
  @extend %listItemBackground;
  // give more space for title if no accessories
  .note__title {
    grid-column: 2 / 4;
  }  
  &--with-accessories .note__title {
    grid-column: 2 / 3;
  }
  // prevents flickering with animated pseudo element
  .note__day, .note__title {
    z-index: 1;
  }
  .note__day, .note__title, .note__accessories  {
    transition: $t transform ease-out, $t background-color ease-out;
  }
  &:hover {
    @extend %listItemBackgroundHover;
    $d: .25ex;
    .note__day, .note__title {
      transform: translateX($d);
    }
    .note__accessories {
      transform: translateX(-$d);
    }
    .note__day, .note__title, .note__accessories {
      transition-duration: math.div($t, 4); 
    }
  }
  &:active {
    @extend %listItemBackgroundActive;
  }
}

.note__preview {
  display: flex;
  grid-column: 1 / -1;
  z-index: 1;
  aspect-ratio: 4 / 3;
  overflow: clip;
  border-radius: 4px;
  position: relative;
  &::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 4px;
    $s: 0 0 0 var(--px) var(--edgeColor);
    box-shadow: $s, inset $s;
  }
  video {
    width: 100%;
    height: auto;
  }
}

.note__day {
  font-variant-numeric: tabular-nums;
  text-decoration: none;
  text-align: right;
  &--hidden {
    visibility: hidden; 
  }
}

.note__title {
  padding: 0 $note-title-gap 0 0;
}
.page {
  display: grid;
}

.page--notes {
  grid-template-columns: min-content minmax(320px, max-content);
  gap: 1.2em;
  padding: var(--type-0);
  @media (width <= $breakpoint) {
    grid-template-columns: 100%;
    grid-template-rows: min-content auto;
    width: 100dvw;
  }
}

.page--note {
  padding: var(--col);
}

.nav__title {
  @extend %font--display-black;
}

.navigation__items {
  display: flex;
  flex-direction: column;
  gap: 1.2em;
  align-items: flex-end;
  @media (width <= $breakpoint) {
    flex-direction: row;
    justify-content: space-between;
  }
}

.nav__link {
  text-decoration: none;
  position: relative;
  @extend %listItemBackground;
  transition: $t transform ease-out;
  &:hover {
    @extend %listItemBackgroundHover;
  }
}
